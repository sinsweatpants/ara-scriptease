<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงุฎุชุจุงุฑ ุงูุชุฑููู ุงูุชููุงุฆู ููุตูุญุงุช</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            margin: 0;
            padding: 20px;
        }

        .test-panel {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .input-area {
            width: 100%;
            height: 200px;
            font-family: 'Times New Roman', serif;
            font-size: 14px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            direction: rtl;
        }

        /* Pagination Styles */
        .screenplay-pages {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            background-color: #f5f5f5;
            padding: 20px;
            min-height: 400px;
        }

        .page {
            width: 210mm;
            height: 297mm;
            background: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            page-break-after: always;
        }

        .page-content {
            padding: 1in 1in 1in 1.5in;
            height: calc(297mm - 2in);
            overflow: hidden;
            direction: rtl;
            box-sizing: border-box;
            font-family: 'Amiri', 'Times New Roman', serif;
            font-size: 12pt;
            line-height: 1.5;
        }

        .page-number {
            position: absolute;
            bottom: 0.5in;
            left: 1in;
            font-size: 10pt;
            color: #666;
        }

        .page-overflow-indicator {
            position: absolute;
            bottom: 1in;
            right: 1.5in;
            background: rgba(255, 0, 0, 0.1);
            border: 1px dashed red;
            padding: 2px 4px;
            font-size: 8pt;
            color: red;
        }

        .page.overflow .page-overflow-indicator {
            display: block;
        }

        /* Element Styles */
        .basmala {
            text-align: left;
            margin: 0 0 2rem 0;
            font-weight: bold;
            font-size: 14pt;
        }

        .scene-header-container {
            width: 100%;
            margin-bottom: 20px;
            background: rgba(0, 100, 200, 0.1);
            padding: 10px;
            border-radius: 6px;
        }

        .scene-header-top-line {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin: 0;
            font-weight: bold;
        }

        .scene-header-3 {
            text-align: center;
            font-weight: bold;
            margin: 5px 0 0 0;
        }

        .action {
            text-align: right;
            margin: 1rem 0;
            font-size: 12pt;
        }

        .dialogue-block {
            margin: 15px 0;
            background: rgba(0, 200, 100, 0.1);
            padding: 15px;
            border-radius: 6px;
        }

        .character-name {
            text-align: center;
            font-weight: bold;
            text-transform: uppercase;
            margin: 0 auto;
            width: 2.5in;
        }

        .parenthetical {
            text-align: center;
            font-style: italic;
            margin: 0 auto;
            width: 2.0in;
        }

        .dialogue-text {
            text-align: center;
            margin: 0 auto 0.3rem auto;
            width: 2.5in;
            line-height: 1.2;
        }

        .transition {
            text-align: center;
            font-weight: bold;
            text-transform: uppercase;
            margin: 1rem 0;
            background: rgba(200, 100, 0, 0.1);
            padding: 10px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        button {
            padding: 8px 16px;
            border: 1px solid #ccc;
            background: #f9f9f9;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background: #e9e9e9;
        }

        .stats {
            background: #333;
            color: white;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="test-panel">
        <h2>๐ ุงุฎุชุจุงุฑ ุงูุชุฑููู ุงูุชููุงุฆู ููุตูุญุงุช</h2>
        <p>ุฃุฏุฎู ูุต ุงูุณููุงุฑูู ุฃุฏูุงู ูุงุฎุชุจุฑ ุงูุชูุณูู ุงูุชููุงุฆู ููุตูุญุงุช ูุน ุงูุงูุชุฒุงู ุจุญุฏูุฏ A4</p>

        <textarea class="input-area" id="screenplay-input" placeholder="ุฃุฏุฎู ูุต ุงูุณููุงุฑูู ููุง...">ุจุณู ุงููู ุงูุฑุญูู ุงูุฑุญูู

ูุดูุฏ 1 ููู-ุฏุงุฎูู
ุดูุฉ ููุฏ ูู ุจูุฑูุช

ุชุฑูุฏ ููุฏ ุนูู ุงูุณุฑูุฑ ููู ุชูุธุฑ ุฅูู ุงูุณูู. ุงูุบุฑูุฉ ูุถุงุกุฉ ุจููุฑ ุฎุงูุช ูู ูุตุจุงุญ ุฌุงูุจู. ุชุจุฏู ูููุฉ ููุง ุชุณุชุทูุน ุงูููู.

ููุฏ:
(ูุงูุณุฉ ูููุณูุง)
ูุง ุฃุณุชุทูุน ุงูููู... ูุฐุง ุงูููู ููุชููู.

ุชุฌูุณ ุนูู ุงูุณุฑูุฑ ูุชูุณู ุจูุงุชููุงุ ุชุชุฑุฏุฏ ูุจู ุฃู ุชุทูุจ ุฑููุงู. ุชูุธุฑ ุฅูู ุงูุณุงุนุฉ ุนูู ุงูุทุงููุฉ ุงูุฌุงูุจูุฉ - ููุชุตู ุงูููู.

ููุฏ:
(ุชุทูุจ ุฑููุงู)
ุขูู... ูุงูุงุ ุฃุนุฐุฑููู ุนูู ุงูุงุชุตุงู ูู ูุฐุง ุงูููุช ุงููุชุฃุฎุฑ.

ุตูุช ุงูุฃู ูู ุงููุงุชูุ ุฏุงูุฆ ููุทูุฆู. ููุฏ ุชุชููู ุจุตูุช ููุฎูุถ.

ููุฏ:
ุฃูุง ุจุฎูุฑุ ุจุณ ูุด ูุงุฏุฑุฉ ุฃูุงู. ุนูุฏู ุงูุชุญุงู ููู ุจูุฑุง ูุฎุงููุฉ ุฃููู ูุณูุช ูู ุดู.

ูุทุน ุฅูู

ูุดูุฏ 2 ููุงุฑ-ุฎุงุฑุฌู
ุงูุดุงุฑุน ุฃูุงู ุงูุฌุงูุนุฉ

ุตุจุงุญ ูุดูุณุ ุทูุงุจ ูุชุฌูููู ูู ุงูุณุงุญุฉ ูุชุฌููู ุฅูู ูุงุนุงุช ุงูุงูุชุญุงูุงุช. ููุฏ ุชุณูุฑ ุจุณุฑุนุฉ ููู ุชุญูู ุญููุจุชูุงุ ุชุจุฏู ุฃูุซุฑ ุซูุฉ ูู ุงููููุฉ ุงููุงุถูุฉ.

ุชูุชูู ุจุตุฏููุชูุง ุณุงุฑุฉ ุนูุฏ ุงูุจูุงุจุฉ ุงูุฑุฆูุณูุฉ.

ุณุงุฑุฉ:
ุตุจุงุญ ุงูุฎูุฑ ูุง ููุฏ! ุชุจุฏูู ูุชุนุจุฉ ุดูู.

ููุฏ:
(ุชุจุชุณู)
ูู ุฃูู ุฌูุฏุงู ุงููููุฉ ุงููุงุถูุฉุ ุจุณ ุฃุญุณู ูู ุฃูุณ.
ูุงู ูุฏู ุงููุซูุฑ ููุชูููุฑ ูููุ ุจุณ ุงูุญูุฏ ููู ููู ุชูุงู.

ุณุงุฑุฉ:
(ุชุฑุจุช ุนูู ูุชููุง)
ูุง ุชุฎุงููุ ุฅูุช ูุญุถุฑุฉ ูููุญ. ูุงููู ูุฑูุญ ูุดุฑุจ ูููุฉ ูุจู ุงูุงูุชุญุงู.

ุชุฏุฎูุงู ูุนุงู ุฅูู ูุจูู ุงูุฌุงูุนุฉ ูุณุท ุฒุญูุฉ ุงูุทูุงุจ. ุงููุงููุฑุง ุชุชุจุนููุง ูููุง ููุดูุงู ูู ุงูููุฑ ุงูุทููู.

ูุทุน ุฅูู

ูุดูุฏ 3 ุฏุงุฎูู-ููุงุฑ
ูุงุนุฉ ุงูุงูุชุญุงูุงุช

ูุงุนุฉ ูุจูุฑุฉ ูููุฆุฉ ุจุงูุทูุงุจุ ุงูุฌููุน ูุญุถุฑ ุฃูุฑุงูู ูุฃููุงูู. ููุฏ ุชุฌูุณ ูู ุงูููุฏูุฉุ ุชุฃุฎุฐ ููุณุงู ุนูููุงู ูุชูุธุฑ ุญูููุง.

ุงูุฃุณุชุงุฐ ูุฏุฎู ุญุงููุงู ุฃูุฑุงู ุงูุงูุชุญุงู.

ุงูุฃุณุชุงุฐ:
ุตุจุงุญ ุงูุฎูุฑ ุฌููุนุงู. ุนูุฏูู ุณุงุนุชูู ููุฅุฌุงุจุฉ ุนูู ุฌููุน ุงูุฃุณุฆูุฉ.
ุฅุฐุง ูู ุฃู ุงุณุชูุณุงุฑุ ุงุฑูุนูุง ุฅูุฏูู.

ูุจุฏุฃ ุชูุฒูุน ุงูุฃูุฑุงู. ููุฏ ุชุณุชูู ูุฑูุชูุง ูุชูุฑุฃ ุงูุฃุณุฆูุฉ ุจุชุฑููุฒ.

ููุฏ:
(ุชููุฑ ูู ููุณูุง)
ุงูุญูุฏ ูููุ ุงูุฃุณุฆูุฉ ูุงุถุญุฉ ูุฃูุง ุฃุนุฑู ุฅุฌุงุจุงุชูุง.

ุชุจุฏุฃ ุจุงููุชุงุจุฉ ุจุซูุฉ. ุงููุงููุฑุง ุชุธูุฑ ุชุนุงุจูุฑ ูุฌููุง ููู ุชูุชูู ูู ุงูููู ุฅูู ุงูุฑุงุญุฉ ูุงูุซูุฉ.

ุงูุชูุงุก</textarea>

        <div class="controls">
            <button onclick="testPagination()">ุงุฎุชุจุฑ ุงูุชุฑููู</button>
            <button onclick="clearResults()">ูุณุญ ุงููุชุงุฆุฌ</button>
        </div>

        <div id="stats" class="stats" style="display: none;"></div>
    </div>

    <div id="pagination-result"></div>

    <script type="module">
        // Simple pagination engine for testing
        class SimplePaginationEngine {
            constructor() {
                this.maxPageHeight = 700; // Approximate content height for A4
            }

            analyzeContent(text) {
                const lines = text.split('\n');
                const elements = [];

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();

                    if (!line) {
                        elements.push({
                            type: 'action',
                            content: '',
                            estimatedHeight: 12,
                            lineCount: 1
                        });
                        continue;
                    }

                    if (/^\s*ุจุณู\s+ุงููู\s+ุงูุฑุญูู\s+ุงูุฑุญูู\s*$/.test(line)) {
                        elements.push({
                            type: 'basmala',
                            content: line,
                            estimatedHeight: 36,
                            lineCount: 1
                        });
                    }
                    else if (line.match(/^(ูุดูุฏ|ู\.)\s*\d+/i)) {
                        let sceneContent = line;
                        let lineCount = 1;

                        if (i + 1 < lines.length && lines[i + 1].trim() &&
                            !this.isNewElement(lines[i + 1].trim())) {
                            i++;
                            sceneContent += '\n' + lines[i].trim();
                            lineCount = 2;
                        }

                        elements.push({
                            type: 'scene-header',
                            content: sceneContent,
                            estimatedHeight: lineCount * 18 + 20,
                            lineCount
                        });
                    }
                    else if (this.isTransition(line)) {
                        elements.push({
                            type: 'transition',
                            content: line,
                            estimatedHeight: 24,
                            lineCount: 1
                        });
                    }
                    else if (this.isCharacterName(line)) {
                        let dialogueContent = line;
                        let dialogueHeight = 18;
                        let lineCount = 1;

                        while (i + 1 < lines.length && lines[i + 1].trim() &&
                               !this.isNewElement(lines[i + 1].trim())) {
                            i++;
                            const dialogueLine = lines[i].trim();
                            dialogueContent += '\n' + dialogueLine;
                            lineCount++;

                            if (this.isParenthetical(dialogueLine)) {
                                dialogueHeight += 16;
                            } else {
                                dialogueHeight += 18;
                            }
                        }

                        elements.push({
                            type: 'dialogue',
                            content: dialogueContent,
                            estimatedHeight: dialogueHeight + 15,
                            lineCount
                        });
                    }
                    else {
                        const lineCount = Math.ceil(line.length / 80);
                        elements.push({
                            type: 'action',
                            content: line,
                            estimatedHeight: lineCount * 18 + 6,
                            lineCount
                        });
                    }
                }

                return elements;
            }

            createPages(elements) {
                const pages = [];
                let currentPage = {
                    pageNumber: 1,
                    elements: [],
                    height: 0,
                    overflow: false
                };

                for (const element of elements) {
                    const willOverflow = currentPage.height + element.estimatedHeight > this.maxPageHeight;

                    if (willOverflow && currentPage.elements.length > 0) {
                        pages.push(currentPage);

                        currentPage = {
                            pageNumber: pages.length + 1,
                            elements: [element],
                            height: element.estimatedHeight,
                            overflow: false
                        };
                    } else {
                        currentPage.elements.push(element);
                        currentPage.height += element.estimatedHeight;

                        if (currentPage.height > this.maxPageHeight * 0.95) {
                            currentPage.overflow = true;
                        }
                    }
                }

                if (currentPage.elements.length > 0) {
                    pages.push(currentPage);
                }

                return pages.length > 0 ? pages : [{
                    pageNumber: 1,
                    elements: [],
                    height: 0,
                    overflow: false
                }];
            }

            generateHTML(text) {
                const elements = this.analyzeContent(text);
                const pages = this.createPages(elements);

                let html = '<div class="screenplay-pages">';

                for (const page of pages) {
                    const overflowClass = page.overflow ? ' overflow' : '';
                    html += `<div class="page${overflowClass}" data-page="${page.pageNumber}">`;
                    html += '<div class="page-content">';

                    for (const element of page.elements) {
                        html += this.elementToHTML(element);
                    }

                    html += '</div>';
                    html += `<div class="page-number">${page.pageNumber}</div>`;

                    if (page.overflow) {
                        html += '<div class="page-overflow-indicator">ุชุฌุงูุฒ ุงูุตูุญุฉ</div>';
                    }

                    html += '</div>';
                }

                html += '</div>';
                return { html, pages };
            }

            elementToHTML(element) {
                const content = this.escapeHtml(element.content);

                switch (element.type) {
                    case 'basmala':
                        return `<div class="basmala">${content}</div>`;

                    case 'scene-header':
                        return this.formatSceneHeader(content);

                    case 'action':
                        return element.content ? `<div class="action">${content}</div>` : '<div class="action"><br></div>';

                    case 'dialogue':
                        return this.formatDialogue(content);

                    case 'transition':
                        return `<div class="transition">${content}</div>`;

                    default:
                        return `<div class="action">${content}</div>`;
                }
            }

            formatSceneHeader(content) {
                const lines = content.split('\n');
                const firstLine = lines[0];
                const secondLine = lines[1] || '';

                const sceneMatch = firstLine.match(/^(ูุดูุฏ|ู\.)\s*(\d+)\s*[-โโ]?\s*(.*)/i);
                if (sceneMatch) {
                    const sceneNum = `${sceneMatch[1]} ${sceneMatch[2]}`;
                    const timeLocation = sceneMatch[3] || '';

                    return `
                        <div class="scene-header-container">
                            <div class="scene-header-top-line">
                                <span class="scene-header-1">${this.escapeHtml(sceneNum)}</span>
                                <span class="scene-header-2">${this.escapeHtml(timeLocation)}</span>
                            </div>
                            <div class="scene-header-3">${this.escapeHtml(secondLine)}</div>
                        </div>`;
                }

                return `<div class="scene-header-container">${this.escapeHtml(content)}</div>`;
            }

            formatDialogue(content) {
                const lines = content.split('\n');
                let html = '<div class="dialogue-block">';

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();

                    if (i === 0) {
                        html += `<div class="character-name">${this.escapeHtml(line.replace(':', ''))}</div>`;
                    } else if (this.isParenthetical(line)) {
                        html += `<div class="parenthetical">${this.escapeHtml(line)}</div>`;
                    } else {
                        html += `<div class="dialogue-text">${this.escapeHtml(line)}</div>`;
                    }
                }

                html += '</div>';
                return html;
            }

            isCharacterName(line) {
                return /^\s*[\u0600-\u06FF][\u0600-\u06FF\s]{0,40}\s*:\s*$/.test(line);
            }

            isParenthetical(line) {
                return line.match(/^\(.*\)$/) !== null;
            }

            isTransition(line) {
                const patterns = [
                    /^\s*(?:ูุทุน|ุฅูู|ุฐูุจุงู|ูุฒุฌ|ูุทุน ุฅูู|ุฎุงุฑุฌ ุงููุดูุฏ|ุงูุชูุงุก)\s*$/i
                ];
                return patterns.some(pattern => pattern.test(line));
            }

            isNewElement(line) {
                return (
                    line.match(/^(ูุดูุฏ|ู\.)\s*\d+/i) !== null ||
                    this.isTransition(line) ||
                    this.isCharacterName(line) ||
                    /^\s*ุจุณู\s+ุงููู\s+ุงูุฑุญูู\s+ุงูุฑุญูู\s*$/.test(line)
                );
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        const engine = new SimplePaginationEngine();

        window.testPagination = function() {
            const input = document.getElementById('screenplay-input').value;
            const result = engine.generateHTML(input);

            document.getElementById('pagination-result').innerHTML = result.html;

            // Show stats
            const statsDiv = document.getElementById('stats');
            statsDiv.style.display = 'block';
            statsDiv.innerHTML = `
                ๐ ุฅุญุตุงุฆูุงุช ุงูุชุฑููู:
                โข ุนุฏุฏ ุงูุตูุญุงุช: ${result.pages.length}
                โข ุงูุตูุญุงุช ุงูุชู ุชุญุชูู ุนูู ูุงุฆุถ: ${result.pages.filter(p => p.overflow).length}
                โข ูุชูุณุท ุงูุงุฑุชูุงุน ููุตูุญุฉ: ${Math.round(result.pages.reduce((sum, p) => sum + p.height, 0) / result.pages.length)}px
                โข ุฅุฌูุงูู ุงูุนูุงุตุฑ: ${result.pages.reduce((sum, p) => sum + p.elements.length, 0)}
            `;
        };

        window.clearResults = function() {
            document.getElementById('pagination-result').innerHTML = '';
            document.getElementById('stats').style.display = 'none';
        };

        // Auto test on load
        window.testPagination();
    </script>
</body>
</html>